name: Deploy Authentication WebApp to Railway

on:
  push:
    branches:
      - release
      - Release
    paths:
      - 'SDMSApps/SDMS.AuthenticationWebApp/**'
      - '.github/workflows/deploy-auth-railway.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: SDMSApps/SDMS.AuthenticationWebApp/ClientApp/package.json

      - name: Clean old node_modules
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: |
          rm -f package-lock.json
          rm -rf node_modules || true

      - name: Install Angular dependencies
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: npm install --legacy-peer-deps

      - name: Build Angular app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: npm run build -- --configuration production

      - name: Restore .NET dependencies
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet restore

      - name: Build .NET app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet build --configuration Release --no-restore

      - name: Publish .NET app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet publish --configuration Release --no-build --output ./publish

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Set Railway environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SERVICE_ID: ${{ vars.RAILWAY_SERVICE_ID }}
          PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID }}
          # Secrets
          SDMS_AuthenticationWebApp_ConnectionString: ${{ secrets.SDMS_AuthenticationWebApp_ConnectionString }}
          SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret: ${{ secrets.SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret: ${{ secrets.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret }}
          SDMS_AuthenticationWebApp_WebhookSecret: ${{ secrets.SDMS_AuthenticationWebApp_WebhookSecret }}
          # Vars
          SDMS_AuthenticationWebApp_FrontendUrl: ${{ vars.SDMS_AuthenticationWebApp_FrontendUrl }}
          SDMS_AuthenticationWebApp_LoginUrl: ${{ vars.SDMS_AuthenticationWebApp_LoginUrl }}
          SDMS_AuthenticationWebApp_LogoutUrl: ${{ vars.SDMS_AuthenticationWebApp_LogoutUrl }}
          SDMS_AuthenticationWebApp_ErrorUrl: ${{ vars.SDMS_AuthenticationWebApp_ErrorUrl }}
          SDMS_AuthenticationWebApp_ReturnUrlParameter: ${{ vars.SDMS_AuthenticationWebApp_ReturnUrlParameter }}
          SDMS_AuthenticationWebApp_ServerPort: ${{ vars.SDMS_AuthenticationWebApp_ServerPort }}
          SDMS_AuthenticationWebApp_ServerUrls: ${{ vars.SDMS_AuthenticationWebApp_ServerUrls }}
          SDMS_AuthenticationWebApp_SigningKeyPath: ${{ vars.SDMS_AuthenticationWebApp_SigningKeyPath }}
          SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId }}
          SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri }}
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: |
          echo "=== Setting Railway Environment Variables ==="
          echo "Service ID: $SERVICE_ID"
          echo "Project ID: $PROJECT_ID"
          echo ""

          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "❌ RAILWAY_TOKEN missing. Add it to GitHub secrets."
            exit 1
          fi

          if ! command -v railway &> /dev/null; then
            echo "❌ Railway CLI not found."
            exit 1
          fi

          echo "Railway CLI version: $(railway --version)"
          echo ""

          set_railway_env() {
            local VAR_NAME=$1
            local VAR_VALUE=$2

            if [ -z "$VAR_VALUE" ] || [[ "$VAR_VALUE" == "your-"* ]] || [[ "$VAR_VALUE" == "placeholder"* ]]; then
              echo "⚠️  Skipping $VAR_NAME (empty or placeholder)"
              return 0
            fi

            echo -n "Setting $VAR_NAME... "
            OUTPUT=$(railway variables set "${VAR_NAME}=${VAR_VALUE}" --service "$SERVICE_ID" --project "$PROJECT_ID" 2>&1)
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              echo "✅"
            else
              echo "❌"
              echo "   Error: $(echo "$OUTPUT" | head -2)"
            fi
          }

          echo "=== Setting Variables ==="
          set_railway_env "SDMS_AuthenticationWebApp_ConnectionString" "$SDMS_AuthenticationWebApp_ConnectionString"
          set_railway_env "SDMS_AuthenticationWebApp_FrontendUrl" "$SDMS_AuthenticationWebApp_FrontendUrl"
          set_railway_env "SDMS_AuthenticationWebApp_LoginUrl" "$SDMS_AuthenticationWebApp_LoginUrl"
          set_railway_env "SDMS_AuthenticationWebApp_LogoutUrl" "$SDMS_AuthenticationWebApp_LogoutUrl"
          set_railway_env "SDMS_AuthenticationWebApp_ErrorUrl" "$SDMS_AuthenticationWebApp_ErrorUrl"
          set_railway_env "SDMS_AuthenticationWebApp_ReturnUrlParameter" "$SDMS_AuthenticationWebApp_ReturnUrlParameter"
          set_railway_env "SDMS_AuthenticationWebApp_ServerPort" "$SDMS_AuthenticationWebApp_ServerPort"
          set_railway_env "SDMS_AuthenticationWebApp_ServerUrls" "$SDMS_AuthenticationWebApp_ServerUrls"
          set_railway_env "SDMS_AuthenticationWebApp_SigningKeyPath" "$SDMS_AuthenticationWebApp_SigningKeyPath"
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId" "$SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId"
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret" "$SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret"
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain"
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId"
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret"
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri" "$SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri"
          set_railway_env "SDMS_AuthenticationWebApp_WebhookSecret" "$SDMS_AuthenticationWebApp_WebhookSecret"

          echo ""
          echo "✅ Environment variables setup completed."

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: |
          echo "=== Deploying to Railway ==="
          railway up --service ${{ vars.RAILWAY_SERVICE_ID }}
          echo "✅ Deployment complete."
