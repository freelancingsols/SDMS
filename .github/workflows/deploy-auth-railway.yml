name: Deploy Authentication WebApp to Railway

on:
  push:
    branches:
      - release
      - Release
    paths:
      - 'SDMSApps/SDMS.AuthenticationWebApp/**'
      - '.github/workflows/deploy-auth-railway.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: SDMSApps/SDMS.AuthenticationWebApp/ClientApp/package.json

      - name: Remove old package-lock.json and node_modules
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: |
          rm -f package-lock.json
          rm -rf node_modules || true

      - name: Install Angular dependencies
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: npm install --legacy-peer-deps

      - name: Build Angular app - Build Node code first
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: npm run build -- --configuration production

      - name: Restore .NET dependencies
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet restore

      - name: Build .NET app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet build --configuration Release --no-restore

      - name: Publish .NET app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet publish --configuration Release --no-build --output ./publish

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Verify Railway CLI and Authentication
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "=== Verifying Railway CLI and Authentication ==="
          echo ""
          
          # Check Railway CLI installation
          echo "1. Checking Railway CLI installation..."
          if ! command -v railway &> /dev/null; then
            echo "‚ùå Railway CLI not found in PATH"
            exit 1
          fi
          RAILWAY_VERSION=$(railway --version 2>&1 || echo "unknown")
          echo "‚úÖ Railway CLI installed: $RAILWAY_VERSION"
          echo ""
          
          # Check RAILWAY_TOKEN
          echo "2. Checking RAILWAY_TOKEN..."
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå Error: RAILWAY_TOKEN is not set in GitHub secrets"
            echo "Please set RAILWAY_TOKEN in: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          echo "‚úÖ RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN} characters)"
          echo ""
          
          # Check SERVICE_ID and PROJECT_ID
          echo "3. Checking configuration variables..."
          SERVICE_ID="${{ vars.RAILWAY_SERVICE_ID }}"
          PROJECT_ID="${{ vars.RAILWAY_PROJECT_ID }}"
          
          if [ -z "$SERVICE_ID" ]; then
            echo "‚ùå Error: RAILWAY_SERVICE_ID is not set in GitHub variables"
            echo "Please set RAILWAY_SERVICE_ID in: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables"
            exit 1
          fi
          echo "‚úÖ SERVICE_ID: $SERVICE_ID"
          
          if [ -z "$PROJECT_ID" ]; then
            echo "‚ö†Ô∏è  Warning: RAILWAY_PROJECT_ID is not set (optional but recommended)"
          else
            echo "‚úÖ PROJECT_ID: $PROJECT_ID"
          fi
          echo ""
          
          # Test Railway connection
          echo "4. Testing Railway connection..."
          if railway whoami &> /dev/null; then
            echo "‚úÖ Railway authentication successful"
          else
            echo "‚ö†Ô∏è  Could not verify Railway authentication (this is okay if using project token)"
          fi
          echo ""
          
          echo "=== Verification Complete ==="

      - name: Verify Railway CLI and Token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "=== Railway CLI and Token Verification ==="
          echo ""
          
          # Check Railway CLI installation
          echo "1. Railway CLI version:"
          railway --version || (echo "‚ùå Railway CLI not installed" && exit 1)
          echo ""
          
          # Check token
          echo "2. Checking Railway token:"
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå ERROR: RAILWAY_TOKEN is not set in GitHub secrets"
            echo ""
            echo "üìù How to generate Railway token:"
            echo "   1. Go to Railway dashboard: https://railway.app/account/tokens"
            echo "   2. Click 'New Token'"
            echo "   3. Choose token type:"
            echo "      - Project Token (recommended): Go to your project ‚Üí Settings ‚Üí Tokens"
            echo "      - Account Token: For all projects (more permissions)"
            echo "   4. Copy the token"
            echo "   5. Add it to GitHub: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   6. Name: RAILWAY_TOKEN"
            echo ""
            echo "üí° Project Token (recommended):"
            echo "   - Go to: https://railway.app/project/${{ vars.RAILWAY_PROJECT_ID }}/settings/tokens"
            echo "   - Click 'Generate New Token'"
            echo "   - Copy and add to GitHub secrets as RAILWAY_TOKEN"
            echo ""
            exit 1
          fi
          echo "‚úÖ RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN} characters)"
          echo ""
          
          # Check Railway CLI variables command syntax
          echo "3. Railway CLI variables command help:"
          railway variables --help 2>&1 | head -30 || echo "Help command not available"
          echo ""
          
          # Test authentication
          echo "4. Testing Railway authentication:"
          if railway whoami &> /dev/null; then
            echo "‚úÖ Authentication successful"
            railway whoami 2>&1 || true
          else
            echo "‚ö†Ô∏è  Could not verify authentication"
            echo "   This might be normal with project tokens"
          fi
          echo ""

      - name: Discover Railway CLI command syntax
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "=== Discovering Railway CLI Command Syntax ==="
          echo ""
          
          # Get Railway CLI help for variables command
          echo "Railway CLI variables command help:"
          railway variables --help 2>&1 || railway variable --help 2>&1 || echo "Help not available"
          echo ""
          
          # Check if there's a 'set' subcommand
          echo "Checking for 'set' subcommand:"
          railway variables set --help 2>&1 | head -20 || echo "No 'set' subcommand found"
          echo ""
          
          # List available commands
          echo "Available Railway CLI commands:"
          railway --help 2>&1 | grep -A 20 "COMMANDS:" || railway --help 2>&1 | head -30
          echo ""

      - name: Set Railway environment variables using CLI with error checking
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SERVICE_ID: ${{ vars.RAILWAY_SERVICE_ID }}
          # Connection String (Secret) - REQUIRED
          SDMS_AuthenticationWebApp_ConnectionString: ${{ secrets.SDMS_AuthenticationWebApp_ConnectionString }}
          # Frontend Configuration (Variable)
          SDMS_AuthenticationWebApp_FrontendUrl: ${{ vars.SDMS_AuthenticationWebApp_FrontendUrl }}
          # Authentication URLs (Variables)
          SDMS_AuthenticationWebApp_LoginUrl: ${{ vars.SDMS_AuthenticationWebApp_LoginUrl }}
          SDMS_AuthenticationWebApp_LogoutUrl: ${{ vars.SDMS_AuthenticationWebApp_LogoutUrl }}
          SDMS_AuthenticationWebApp_ErrorUrl: ${{ vars.SDMS_AuthenticationWebApp_ErrorUrl }}
          SDMS_AuthenticationWebApp_ReturnUrlParameter: ${{ vars.SDMS_AuthenticationWebApp_ReturnUrlParameter }}
          # Server Configuration (Variables)
          SDMS_AuthenticationWebApp_ServerPort: ${{ vars.SDMS_AuthenticationWebApp_ServerPort }}
          SDMS_AuthenticationWebApp_ServerUrls: ${{ vars.SDMS_AuthenticationWebApp_ServerUrls }}
          # External Authentication (Google) - ClientId is Variable, ClientSecret is Secret
          SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId }}
          SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret: ${{ secrets.SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret }}
          # External Authentication (Auth0) - Domain and ClientId are Variables, ClientSecret is Secret
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret: ${{ secrets.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret }}
          # External Authentication (Redirect URI) (Variable)
          SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri }}
          # Webhook (Secret)
          SDMS_AuthenticationWebApp_WebhookSecret: ${{ secrets.SDMS_AuthenticationWebApp_WebhookSecret }}
          # Signing Key Path (Variable)
          SDMS_AuthenticationWebApp_SigningKeyPath: ${{ vars.SDMS_AuthenticationWebApp_SigningKeyPath }}
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: |
          SERVICE_ID="${{ vars.RAILWAY_SERVICE_ID }}"
          PROJECT_ID="${{ vars.RAILWAY_PROJECT_ID }}"
          
          if [ -z "$SERVICE_ID" ]; then
            echo "‚ùå Error: RAILWAY_SERVICE_ID is not set"
            exit 1
          fi
          
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå Error: RAILWAY_TOKEN is not set in GitHub secrets"
            echo ""
            echo "üìù How to generate Railway token:"
            echo "   1. Go to: https://railway.app/project/$PROJECT_ID/settings/tokens"
            echo "   2. Click 'Generate New Token'"
            echo "   3. Copy the token"
            echo "   4. Add to GitHub: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   5. Name: RAILWAY_TOKEN"
            exit 1
          fi
          
          echo "=== Setting Railway Environment Variables ==="
          echo "Service ID: $SERVICE_ID"
          echo "Project ID: $PROJECT_ID"
          echo ""
          
          # Determine which Railway CLI command syntax works
          echo "Discovering Railway CLI syntax..."
          RAILWAY_CMD=""
          RAILWAY_CMD_TYPE="unknown"
          
          # Check if 'railway variables' (plural) command exists and has 'set' subcommand
          if railway variables set --help &>/dev/null 2>&1; then
            RAILWAY_CMD="variables set"
            RAILWAY_CMD_TYPE="plural_with_set"
            echo "‚úÖ Found: railway variables set"
          elif railway variables --help &>/dev/null 2>&1; then
            # Check if variables command accepts KEY=VALUE directly
            RAILWAY_CMD="variables"
            RAILWAY_CMD_TYPE="plural_direct"
            echo "‚úÖ Found: railway variables (direct)"
          fi
          
          # Check if 'railway variable' (singular) command exists
          if [ -z "$RAILWAY_CMD" ]; then
            if railway variable set --help &>/dev/null 2>&1; then
              RAILWAY_CMD="variable set"
              RAILWAY_CMD_TYPE="singular_with_set"
              echo "‚úÖ Found: railway variable set"
            elif railway variable --help &>/dev/null 2>&1; then
              RAILWAY_CMD="variable"
              RAILWAY_CMD_TYPE="singular_direct"
              echo "‚úÖ Found: railway variable (direct)"
            fi
          fi
          
          if [ -z "$RAILWAY_CMD" ] || [ "$RAILWAY_CMD_TYPE" = "unknown" ]; then
            echo "‚ö†Ô∏è  Could not auto-detect Railway CLI command syntax"
            echo "   Will try multiple syntax variations..."
            RAILWAY_CMD_TYPE="unknown"
          fi
          
          echo ""
          
          # Function to set variable with comprehensive error checking
          set_railway_var() {
            local VAR_NAME=$1
            local VAR_VALUE=$2
            local VAR_TYPE=${3:-"variable"}  # "secret" or "variable"
            
            # Skip if value is empty or placeholder
            if [ -z "$VAR_VALUE" ] || [[ "$VAR_VALUE" == "your-"* ]] || [[ "$VAR_VALUE" == "placeholder"* ]]; then
              echo "‚ö†Ô∏è  Skipping $VAR_NAME (value is empty or placeholder)"
              return 0
            fi
            
            echo -n "Setting $VAR_TYPE $VAR_NAME... "
            
            local SUCCESS=0
            local LAST_ERROR=""
            local OUTPUT=""
            local EXIT_CODE=0
            
            # Try different command syntaxes based on discovered command type
            if [ "$RAILWAY_CMD_TYPE" = "plural_with_set" ]; then
              # Method 1: railway variables set KEY=VALUE --service SERVICE_ID
              OUTPUT=$(railway variables set "${VAR_NAME}=${VAR_VALUE}" --service "$SERVICE_ID" 2>&1) || EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                SUCCESS=1
                METHOD_USED="railway variables set KEY=VALUE --service"
              else
                LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
                
                # Method 2: railway variables set KEY VALUE --service SERVICE_ID (space separated)
                OUTPUT=$(railway variables set "$VAR_NAME" "$VAR_VALUE" --service "$SERVICE_ID" 2>&1) || EXIT_CODE=$?
                if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                  SUCCESS=1
                  METHOD_USED="railway variables set KEY VALUE --service"
                else
                  LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
                fi
              fi
            elif [ "$RAILWAY_CMD_TYPE" = "singular_with_set" ]; then
              # Method 3: railway variable set KEY=VALUE --service SERVICE_ID
              OUTPUT=$(railway variable set "${VAR_NAME}=${VAR_VALUE}" --service "$SERVICE_ID" 2>&1) || EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                SUCCESS=1
                METHOD_USED="railway variable set KEY=VALUE --service"
              else
                LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
                
                # Method 4: railway variable set KEY VALUE --service SERVICE_ID (space separated)
                OUTPUT=$(railway variable set "$VAR_NAME" "$VAR_VALUE" --service "$SERVICE_ID" 2>&1) || EXIT_CODE=$?
                if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                  SUCCESS=1
                  METHOD_USED="railway variable set KEY VALUE --service"
                else
                  LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
                fi
              fi
            elif [ "$RAILWAY_CMD_TYPE" = "plural_direct" ]; then
              # Method 5: railway variables KEY=VALUE --service SERVICE_ID
              OUTPUT=$(railway variables "${VAR_NAME}=${VAR_VALUE}" --service "$SERVICE_ID" 2>&1) || EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                SUCCESS=1
                METHOD_USED="railway variables KEY=VALUE --service"
              else
                LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
              fi
            fi
            
            # Fallback: Try common syntaxes if auto-detection didn't work
            if [ $SUCCESS -eq 0 ]; then
              # Try: railway variable set KEY VALUE (without --service, project token scopes it)
              OUTPUT=$(railway variable set "$VAR_NAME" "$VAR_VALUE" 2>&1) || EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                SUCCESS=1
                METHOD_USED="railway variable set KEY VALUE (no --service)"
              else
                LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
              fi
            fi
            
            if [ $SUCCESS -eq 0 ]; then
              # Try: railway variables set KEY=VALUE (without --service)
              OUTPUT=$(railway variables set "${VAR_NAME}=${VAR_VALUE}" 2>&1) || EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                SUCCESS=1
                METHOD_USED="railway variables set KEY=VALUE (no --service)"
              else
                LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
              fi
            fi
            
            if [ $SUCCESS -eq 0 ]; then
              # Try: stdin pipe method (for special characters)
              OUTPUT=$(echo -n "$VAR_VALUE" | railway variable set "$VAR_NAME" --service "$SERVICE_ID" 2>&1) || EXIT_CODE=$?
              if [ $EXIT_CODE -eq 0 ] && ! echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|permission|denied"; then
                SUCCESS=1
                METHOD_USED="stdin pipe method"
              else
                LAST_ERROR="$(echo "$OUTPUT" | head -2 | tr '\n' ' ')"
              fi
            fi
            
            # Return result
            if [ $SUCCESS -eq 1 ]; then
              echo "‚úÖ"
              return 0
            else
              echo "‚ùå"
              echo "   Error: $(echo "$LAST_ERROR" | head -1)"
              return 1
            fi
          }
          
          # Track results
          FAILED_VARS=()
          SUCCESS_VARS=()
          CRITICAL_FAILED=0
          
          # Set connection string first (critical)
          echo "=== Setting Critical Variables ==="
          if [ -z "$SDMS_AuthenticationWebApp_ConnectionString" ]; then
            echo "‚ùå Error: SDMS_AuthenticationWebApp_ConnectionString is not set in GitHub secrets"
            exit 1
          fi
          
          if set_railway_var "SDMS_AuthenticationWebApp_ConnectionString" "$SDMS_AuthenticationWebApp_ConnectionString" "secret"; then
            SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ConnectionString")
          else
            FAILED_VARS+=("SDMS_AuthenticationWebApp_ConnectionString")
            CRITICAL_FAILED=1
          fi
          
          echo ""
          echo "=== Setting Configuration Variables ==="
          set_railway_var "SDMS_AuthenticationWebApp_FrontendUrl" "$SDMS_AuthenticationWebApp_FrontendUrl" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_FrontendUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_FrontendUrl")
          set_railway_var "SDMS_AuthenticationWebApp_LoginUrl" "$SDMS_AuthenticationWebApp_LoginUrl" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_LoginUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_LoginUrl")
          set_railway_var "SDMS_AuthenticationWebApp_LogoutUrl" "$SDMS_AuthenticationWebApp_LogoutUrl" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_LogoutUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_LogoutUrl")
          set_railway_var "SDMS_AuthenticationWebApp_ErrorUrl" "$SDMS_AuthenticationWebApp_ErrorUrl" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ErrorUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ErrorUrl")
          set_railway_var "SDMS_AuthenticationWebApp_ReturnUrlParameter" "$SDMS_AuthenticationWebApp_ReturnUrlParameter" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ReturnUrlParameter") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ReturnUrlParameter")
          set_railway_var "SDMS_AuthenticationWebApp_ServerPort" "$SDMS_AuthenticationWebApp_ServerPort" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ServerPort") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ServerPort")
          set_railway_var "SDMS_AuthenticationWebApp_ServerUrls" "$SDMS_AuthenticationWebApp_ServerUrls" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ServerUrls") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ServerUrls")
          set_railway_var "SDMS_AuthenticationWebApp_SigningKeyPath" "$SDMS_AuthenticationWebApp_SigningKeyPath" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_SigningKeyPath") || FAILED_VARS+=("SDMS_AuthenticationWebApp_SigningKeyPath")
          
          echo ""
          echo "=== Setting External Auth Variables ==="
          set_railway_var "SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId" "$SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId")
          set_railway_var "SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret" "$SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret" "secret" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret")
          set_railway_var "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain")
          set_railway_var "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId")
          set_railway_var "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret" "secret" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret")
          set_railway_var "SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri" "$SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri" "variable" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri")
          set_railway_var "SDMS_AuthenticationWebApp_WebhookSecret" "$SDMS_AuthenticationWebApp_WebhookSecret" "secret" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_WebhookSecret") || FAILED_VARS+=("SDMS_AuthenticationWebApp_WebhookSecret")
          
          echo ""
          echo "=== Summary ==="
          echo "‚úÖ Successfully set: ${#SUCCESS_VARS[@]} variable(s)"
          echo "‚ùå Failed to set: ${#FAILED_VARS[@]} variable(s)"
          echo ""
          
          if [ ${#FAILED_VARS[@]} -gt 0 ]; then
            echo "Failed variables:"
            for var in "${FAILED_VARS[@]}"; do
              echo "   - $var"
            done
            echo ""
          fi
          
          if [ ${#SUCCESS_VARS[@]} -gt 0 ]; then
            echo "Successfully set variables:"
            for var in "${SUCCESS_VARS[@]}"; do
              echo "   ‚úÖ $var"
            done
            echo ""
          fi
          
          # Check if we need to fail
          if [ $CRITICAL_FAILED -eq 1 ]; then
            echo "‚ùå CRITICAL ERROR: Connection string failed to set"
            echo "   Variable: SDMS_AuthenticationWebApp_ConnectionString"
            echo "   This is required for the application to work."
            echo ""
            echo "üîß Solutions:"
            echo "   1. Verify RAILWAY_TOKEN is a valid Project Token"
            echo "   2. Check token permissions in Railway dashboard"
            echo "   3. Set variable manually: https://railway.app/project/$PROJECT_ID/service/$SERVICE_ID/variables"
            echo ""
            echo "üìñ See RAILWAY_TOKEN_GUIDE.md for help"
            exit 1
          elif [ ${#FAILED_VARS[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Some variables failed to set, but deployment can continue"
            echo "   Please set failed variables manually in Railway dashboard:"
            echo "   https://railway.app/project/$PROJECT_ID/service/$SERVICE_ID/variables"
            echo ""
            echo "üí° Tip: Check Railway CLI version and token permissions"
          else
            echo "‚úÖ All environment variables set successfully!"
          fi

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: |
          # Railway CLI automatically uses RAILWAY_TOKEN environment variable for authentication
          # Project token is already scoped to the project, so no need to specify --project
          # Deploy to Railway (service is specified if project has multiple services)
          railway up --service ${{ vars.RAILWAY_SERVICE_ID }}

