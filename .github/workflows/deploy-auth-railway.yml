name: Deploy Authentication WebApp to Railway

on:
  push:
    branches:
      - release
      - Release
    paths:
      - 'SDMSApps/SDMS.AuthenticationWebApp/**'
      - '.github/workflows/deploy-auth-railway.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: SDMSApps/SDMS.AuthenticationWebApp/ClientApp/package.json

      - name: Clean old node_modules
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: |
          rm -f package-lock.json
          rm -rf node_modules || true

      - name: Install Angular dependencies
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: npm install --legacy-peer-deps

      - name: Build Angular app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp/ClientApp
        run: npm run build -- --configuration production

      - name: Restore .NET dependencies
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet restore

      - name: Build .NET app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet build --configuration Release --no-restore

      - name: Publish .NET app
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: dotnet publish --configuration Release --no-build --output ./publish

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Set Railway environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SERVICE_ID: ${{ vars.RAILWAY_SERVICE_ID }}
          PROJECT_ID: ${{ vars.RAILWAY_PROJECT_ID }}
          # Secrets
          SDMS_AuthenticationWebApp_ConnectionString: ${{ secrets.SDMS_AuthenticationWebApp_ConnectionString }}
          SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret: ${{ secrets.SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret: ${{ secrets.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret }}
          SDMS_AuthenticationWebApp_WebhookSecret: ${{ secrets.SDMS_AuthenticationWebApp_WebhookSecret }}
          # Vars
          SDMS_AuthenticationWebApp_FrontendUrl: ${{ vars.SDMS_AuthenticationWebApp_FrontendUrl }}
          SDMS_AuthenticationWebApp_LoginUrl: ${{ vars.SDMS_AuthenticationWebApp_LoginUrl }}
          SDMS_AuthenticationWebApp_LogoutUrl: ${{ vars.SDMS_AuthenticationWebApp_LogoutUrl }}
          SDMS_AuthenticationWebApp_ErrorUrl: ${{ vars.SDMS_AuthenticationWebApp_ErrorUrl }}
          SDMS_AuthenticationWebApp_ReturnUrlParameter: ${{ vars.SDMS_AuthenticationWebApp_ReturnUrlParameter }}
          SDMS_AuthenticationWebApp_ServerPort: ${{ vars.SDMS_AuthenticationWebApp_ServerPort }}
          SDMS_AuthenticationWebApp_ServerUrls: ${{ vars.SDMS_AuthenticationWebApp_ServerUrls }}
          SDMS_AuthenticationWebApp_SigningKeyPath: ${{ vars.SDMS_AuthenticationWebApp_SigningKeyPath }}
          SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain }}
          SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId }}
          SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri: ${{ vars.SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri }}
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: |
          echo "=== Setting Railway Environment Variables ==="
          echo "Service ID: $SERVICE_ID"
          echo "Project ID: $PROJECT_ID"
          echo ""

          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå RAILWAY_TOKEN missing. Add it to GitHub secrets."
            exit 1
          fi

          if ! command -v railway &> /dev/null; then
            echo "‚ùå Railway CLI not found."
            exit 1
          fi

          echo "Railway CLI version: $(railway --version)"
          echo ""
          
          # Explicitly export RAILWAY_TOKEN to ensure it's available to Railway CLI
          # Railway CLI automatically uses RAILWAY_TOKEN environment variable for authentication
          export RAILWAY_TOKEN="$RAILWAY_TOKEN"
          
          # Verify token is set and show first few characters for debugging (not the full token)
          echo "Token verification:"
          if [ -n "$RAILWAY_TOKEN" ]; then
            TOKEN_PREFIX=$(echo "$RAILWAY_TOKEN" | cut -c1-8)
            TOKEN_LENGTH=${#RAILWAY_TOKEN}
            echo "  ‚úÖ RAILWAY_TOKEN environment variable is set"
            echo "  ‚úÖ Token length: $TOKEN_LENGTH characters"
            echo "  ‚úÖ Token prefix: $TOKEN_PREFIX..."
            
            # Verify the environment variable is accessible
            if [ "$RAILWAY_TOKEN" = "$(echo $RAILWAY_TOKEN)" ]; then
              echo "  ‚úÖ Token is properly exported and accessible"
            else
              echo "  ‚ö†Ô∏è  Warning: Token may not be properly exported"
            fi
          else
            echo "  ‚ùå RAILWAY_TOKEN is not set"
            exit 1
          fi
          echo ""
          
          # Verify Railway CLI can see the token
          echo "Verifying Railway CLI can access token..."
          if env | grep -q "^RAILWAY_TOKEN="; then
            echo "  ‚úÖ RAILWAY_TOKEN is present in environment"
          else
            echo "  ‚ùå RAILWAY_TOKEN is not found in environment variables"
            exit 1
          fi
          echo ""
          
          # Test Railway CLI authentication and service access
          echo "Testing Railway CLI authentication..."
          AUTH_TEST=$(railway whoami 2>&1)
          AUTH_EXIT=$?
          
          if [ $AUTH_EXIT -eq 0 ]; then
            echo "‚úÖ Authentication successful"
            echo "$AUTH_TEST"
          else
            echo "‚ö†Ô∏è  'railway whoami' failed (exit code: $AUTH_EXIT)"
            echo "   Output: $AUTH_TEST"
            echo "   Note: This might be normal for project tokens (whoami may not work)"
          fi
          
          # Test if we can access the service (this is the critical test)
          echo ""
          echo "Testing service access..."
          SERVICE_TEST=$(railway variables --service "$SERVICE_ID" --json 2>&1 | head -10)
          SERVICE_EXIT=$?
          
          if [ $SERVICE_EXIT -eq 0 ]; then
            echo "‚úÖ Service access verified - token can access service $SERVICE_ID"
            echo "   Current variables: $(echo "$SERVICE_TEST" | wc -l) line(s) of JSON"
          else
            echo "‚ùå CRITICAL: Cannot access service $SERVICE_ID"
            echo "   Exit code: $SERVICE_EXIT"
            echo "   Output: $(echo "$SERVICE_TEST" | head -5)"
            echo ""
            echo "   This usually means:"
            echo "   1. Token is not a Project Token (might be Account Token)"
            echo "   2. Token doesn't have access to this project/service"
            echo "   3. Token is invalid or expired"
            echo ""
            echo "   üí° Solution: Generate a NEW Project Token from:"
            echo "   https://railway.app/project/$PROJECT_ID/settings/tokens"
            echo "   Then update RAILWAY_TOKEN in GitHub secrets"
            echo ""
            exit 1
          fi
          echo ""

          set_railway_env() {
            local VAR_NAME=$1
            local VAR_VALUE=$2

            if [ -z "$VAR_VALUE" ] || [[ "$VAR_VALUE" == "your-"* ]] || [[ "$VAR_VALUE" == "placeholder"* ]]; then
              echo "‚ö†Ô∏è  Skipping $VAR_NAME (empty or placeholder)"
              return 0
            fi

            echo -n "Setting $VAR_NAME... "
            
            # Use railway variables --set command (correct syntax)
            # Note: Railway CLI uses RAILWAY_TOKEN environment variable automatically
            OUTPUT=$(railway variables --set "${VAR_NAME}=${VAR_VALUE}" --service "$SERVICE_ID" 2>&1)
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              # Check if output contains error indicators (including "not found" messages)
              if echo "$OUTPUT" | grep -qiE "error|failed|invalid|unexpected|not found|token|permission|unauthorized"; then
                echo "‚ùå"
                echo "   Error: $(echo "$OUTPUT" | head -3 | tr '\n' ' ')"
                return 1
              else
                echo "‚úÖ"
                return 0
              fi
            else
              echo "‚ùå"
              echo "   Error: Exit code $EXIT_CODE"
              if [ -n "$OUTPUT" ]; then
                echo "   Output: $(echo "$OUTPUT" | head -3 | tr '\n' ' ')"
              fi
              
              # Check for specific token-related errors and provide helpful messages
              if echo "$OUTPUT" | grep -qiE "token.*not found|project token.*not found"; then
                echo ""
                echo "   üí° Troubleshooting 'Project Token not found' error:"
                echo "   1. Verify the token is a Project Token (not Account Token)"
                echo "   2. Generate a new Project Token:"
                echo "      https://railway.app/project/$PROJECT_ID/settings/tokens"
                echo "   3. Make sure the token has not expired"
                echo "   4. Verify the token is correctly set in GitHub secrets"
                echo "   5. Token should start with a UUID format (e.g., d799ae27-...)"
              elif echo "$OUTPUT" | grep -qiE "invalid token|unauthorized|permission"; then
                echo ""
                echo "   üí° Token authentication error:"
                echo "   1. Token might be invalid or expired"
                echo "   2. Generate a new token: https://railway.app/project/$PROJECT_ID/settings/tokens"
                echo "   3. Make sure token has 'Variables' permissions"
              fi
              
              return 1
            fi
          }

          # Track results
          FAILED_VARS=()
          SUCCESS_VARS=()
          CRITICAL_FAILED=0

          echo "=== Setting Critical Variables ==="
          if set_railway_env "SDMS_AuthenticationWebApp_ConnectionString" "$SDMS_AuthenticationWebApp_ConnectionString"; then
            SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ConnectionString")
          else
            FAILED_VARS+=("SDMS_AuthenticationWebApp_ConnectionString")
            CRITICAL_FAILED=1
          fi

          echo ""
          echo "=== Setting Configuration Variables ==="
          set_railway_env "SDMS_AuthenticationWebApp_FrontendUrl" "$SDMS_AuthenticationWebApp_FrontendUrl" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_FrontendUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_FrontendUrl")
          set_railway_env "SDMS_AuthenticationWebApp_LoginUrl" "$SDMS_AuthenticationWebApp_LoginUrl" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_LoginUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_LoginUrl")
          set_railway_env "SDMS_AuthenticationWebApp_LogoutUrl" "$SDMS_AuthenticationWebApp_LogoutUrl" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_LogoutUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_LogoutUrl")
          set_railway_env "SDMS_AuthenticationWebApp_ErrorUrl" "$SDMS_AuthenticationWebApp_ErrorUrl" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ErrorUrl") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ErrorUrl")
          set_railway_env "SDMS_AuthenticationWebApp_ReturnUrlParameter" "$SDMS_AuthenticationWebApp_ReturnUrlParameter" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ReturnUrlParameter") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ReturnUrlParameter")
          set_railway_env "SDMS_AuthenticationWebApp_ServerPort" "$SDMS_AuthenticationWebApp_ServerPort" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ServerPort") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ServerPort")
          set_railway_env "SDMS_AuthenticationWebApp_ServerUrls" "$SDMS_AuthenticationWebApp_ServerUrls" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ServerUrls") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ServerUrls")
          set_railway_env "SDMS_AuthenticationWebApp_SigningKeyPath" "$SDMS_AuthenticationWebApp_SigningKeyPath" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_SigningKeyPath") || FAILED_VARS+=("SDMS_AuthenticationWebApp_SigningKeyPath")

          echo ""
          echo "=== Setting External Auth Variables ==="
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId" "$SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientId")
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret" "$SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Google_ClientSecret")
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_Domain")
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientId")
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret" "$SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_Auth0_ClientSecret")
          set_railway_env "SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri" "$SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri") || FAILED_VARS+=("SDMS_AuthenticationWebApp_ExternalAuth_RedirectUri")
          set_railway_env "SDMS_AuthenticationWebApp_WebhookSecret" "$SDMS_AuthenticationWebApp_WebhookSecret" && SUCCESS_VARS+=("SDMS_AuthenticationWebApp_WebhookSecret") || FAILED_VARS+=("SDMS_AuthenticationWebApp_WebhookSecret")

          echo ""
          echo "=== Summary ==="
          echo "‚úÖ Successfully set: ${#SUCCESS_VARS[@]} variable(s)"
          echo "‚ùå Failed to set: ${#FAILED_VARS[@]} variable(s)"
          echo ""

          if [ ${#FAILED_VARS[@]} -gt 0 ]; then
            echo "Failed variables:"
            for var in "${FAILED_VARS[@]}"; do
              echo "   - $var"
            done
            echo ""
          fi

          if [ $CRITICAL_FAILED -eq 1 ]; then
            echo "‚ùå CRITICAL ERROR: Connection string failed to set"
            echo "   Deployment cannot proceed without the connection string."
            echo "   Please set SDMS_AuthenticationWebApp_ConnectionString manually in Railway dashboard:"
            echo "   https://railway.app/project/$PROJECT_ID/service/$SERVICE_ID/variables"
            exit 1
          elif [ ${#FAILED_VARS[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  Some variables failed to set, but deployment can continue"
            echo "   Please set failed variables manually in Railway dashboard:"
            echo "   https://railway.app/project/$PROJECT_ID/service/$SERVICE_ID/variables"
          else
            echo "‚úÖ All environment variables set successfully!"
          fi

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: SDMSApps/SDMS.AuthenticationWebApp
        run: |
          echo "=== Deploying to Railway ==="
          railway up --service ${{ vars.RAILWAY_SERVICE_ID }}
          echo "‚úÖ Deployment complete."
