name: Deploy B2C WebApp to Vercel

on:
  workflow_run:
    workflows: ["CI - B2C WebApp (Build, Test, and Lint)"]
    types:
      - completed
    branches:
      - release
      - Release
  workflow_dispatch:

concurrency:
  group: deploy-b2c-vercel-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.head_branch != 'master' &&
       github.event.workflow_run.head_branch != 'main' &&
       (github.event.workflow_run.head_branch == 'release' || github.event.workflow_run.head_branch == 'Release')) ||
      (github.event_name == 'workflow_dispatch' && 
       github.ref != 'refs/heads/master' &&
       github.ref != 'refs/heads/main' &&
       (github.ref == 'refs/heads/release' || github.ref == 'refs/heads/Release'))

    steps:
      - name: CRITICAL Block Master/Main Branch Deployments
        run: |
          echo "Checking branch‚Ä¶"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            DEPLOY_BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            DEPLOY_BRANCH="${{ github.ref_name }}"
          fi

          if [ "$DEPLOY_BRANCH" = "master" ] || [ "$DEPLOY_BRANCH" = "main" ]; then
            echo "BLOCKED"; exit 1;
          fi

          if [ "$DEPLOY_BRANCH" != "release" ] && [ "$DEPLOY_BRANCH" != "Release" ]; then
            echo "Invalid branch"; exit 1;
          fi

      - name: Verify Branch for Manual Deployment
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.ref }}" != "refs/heads/release" ] && \
             [ "${{ github.ref }}" != "refs/heads/Release" ]; then
            echo "Manual deploy only allowed on Release branch"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "Deployment starting..."

      - name: Verify CI Status and Application
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "CI failed"; exit 1;
          fi

      - name: Checkout code (workflow_run)
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Checkout code (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: SDMSApps/SDMS.B2CWebApp/ClientApp/package.json

      - name: Validate Secrets and Variables
        run: |
          echo "=== Validating Required Secrets and Variables ==="
          echo ""
          
          # Validate Vercel deployment secrets/variables
          MISSING=0
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ùå Missing VERCEL_TOKEN (secret)"
            MISSING=1
          else
            echo "‚úÖ VERCEL_TOKEN: present (secret)"
          fi
          
          if [ -z "${{ vars.VERCEL_ORG_ID }}" ]; then
            echo "‚ùå Missing VERCEL_ORG_ID (variable)"
            MISSING=1
          else
            echo "‚úÖ VERCEL_ORG_ID: present (variable)"
          fi
          
          if [ -z "${{ vars.VERCEL_PROJECT_ID }}" ]; then
            echo "‚ùå Missing VERCEL_PROJECT_ID (variable)"
            MISSING=1
          else
            echo "‚úÖ VERCEL_PROJECT_ID: present (variable)"
          fi
          
          echo ""
          echo "=== Validating Application Variables ==="
          echo ""
          
          # Validate application variables (required for B2C WebApp)
          if [ -z "${{ vars.SDMS_B2CWebApp_url }}" ]; then
            echo "‚ùå Missing SDMS_B2CWebApp_url (variable)"
            MISSING=1
          else
            echo "‚úÖ SDMS_B2CWebApp_url: present (variable)"
          fi
          
          if [ -z "${{ vars.SDMS_AuthenticationWebApp_url }}" ]; then
            echo "‚ùå Missing SDMS_AuthenticationWebApp_url (variable)"
            MISSING=1
          else
            echo "‚úÖ SDMS_AuthenticationWebApp_url: present (variable)"
          fi
          
          if [ -z "${{ vars.SDMS_AuthenticationWebApp_clientid }}" ]; then
            echo "‚ùå Missing SDMS_AuthenticationWebApp_clientid (variable)"
            MISSING=1
          else
            echo "‚úÖ SDMS_AuthenticationWebApp_clientid: present (variable)"
          fi
          
          if [ -z "${{ vars.SDMS_AuthenticationWebApp_redirectUri }}" ]; then
            echo "‚ùå Missing SDMS_AuthenticationWebApp_redirectUri (variable)"
            MISSING=1
          else
            echo "‚úÖ SDMS_AuthenticationWebApp_redirectUri: present (variable)"
          fi
          
          if [ -z "${{ vars.SDMS_AuthenticationWebApp_scope }}" ]; then
            echo "‚ùå Missing SDMS_AuthenticationWebApp_scope (variable)"
            MISSING=1
          else
            echo "‚úÖ SDMS_AuthenticationWebApp_scope: present (variable)"
          fi
          
          echo ""
          if [ $MISSING -eq 1 ]; then
            echo "‚ùå Validation failed: Missing required secrets/variables"
            echo ""
            echo "Please add missing items to:"
            echo "  - Secrets: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Secrets"
            echo "  - Variables: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables"
            exit 1
          else
            echo "‚úÖ All required secrets and variables are present"
          fi

      - name: Clean modules only
        working-directory: SDMSApps/SDMS.B2CWebApp/ClientApp
        run: rm -rf node_modules || true

      - name: Create Vercel project configuration
        working-directory: SDMSApps/SDMS.B2CWebApp
        env:
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
        run: |
          mkdir -p .vercel
          echo "{\"orgId\":\"$VERCEL_ORG_ID\",\"projectId\":\"$VERCEL_PROJECT_ID\"}" > .vercel/project.json

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Update Vercel project root directory
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
        run: |
          echo "=== Updating Vercel Project Root Directory ==="
          ROOT_DIR="SDMSApps/SDMS.B2CWebApp"
          
          echo "Target root directory: $ROOT_DIR"
          echo ""
          
          # First, get current settings
          echo "üì• Fetching current project settings..."
          CURRENT_SETTINGS=$(curl -s -X GET \
            "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID?teamId=$VERCEL_ORG_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" 2>&1)
          
          # Check if rootDirectory exists and what it's set to
          if echo "$CURRENT_SETTINGS" | grep -q "rootDirectory"; then
            CURRENT_ROOT=$(echo "$CURRENT_SETTINGS" | grep -o '"rootDirectory":"[^"]*"' | cut -d'"' -f4 || echo "not set")
            echo "Current root directory: $CURRENT_ROOT"
            
            if [ "$CURRENT_ROOT" == "$ROOT_DIR" ]; then
              echo "‚úÖ Root directory is already set correctly to: $ROOT_DIR"
              exit 0
            fi
          else
            echo "Root directory not set in current settings"
          fi
          
          echo ""
          echo "üîÑ Updating root directory to: $ROOT_DIR"
          
          # Update root directory
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X PATCH \
            "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID?teamId=$VERCEL_ORG_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"rootDirectory\": \"$ROOT_DIR\"}" 2>&1)
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
          
          echo "API Response Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" == "200" ] || [ "$HTTP_STATUS" == "201" ]; then
            echo "‚úÖ API call successful"
            
            # Wait for update to propagate
            echo "‚è≥ Waiting 3 seconds for settings to propagate..."
            sleep 3
            
            # Verify the update
            echo "üîç Verifying root directory was updated..."
            VERIFY_SETTINGS=$(curl -s -X GET \
              "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID?teamId=$VERCEL_ORG_ID" \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" 2>&1)
            
            VERIFY_ROOT=$(echo "$VERIFY_SETTINGS" | grep -o '"rootDirectory":"[^"]*"' | cut -d'"' -f4 || echo "not found")
            
            if [ "$VERIFY_ROOT" == "$ROOT_DIR" ]; then
              echo "‚úÖ Verified: Root directory is now set to: $ROOT_DIR"
            else
              echo "‚ö†Ô∏è  Warning: Verification shows root directory as: $VERIFY_ROOT"
              echo "   Expected: $ROOT_DIR"
              echo "   The update may need a moment to propagate, or manual update may be required."
            fi
          else
            echo "‚ùå Failed to update root directory (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            echo ""
            echo "‚ö†Ô∏è  Continuing deployment, but it may fail if root directory is incorrect."
            echo "   Please update manually in Vercel dashboard:"
            echo "   1. Go to https://vercel.com/freelancingsols-projects/sdms/settings"
            echo "   2. Settings ‚Üí General ‚Üí Root Directory"
            echo "   3. Set to: $ROOT_DIR"
            echo "   4. Save"
          fi

      - name: Sync Vercel Environment Variables
        working-directory: SDMSApps/SDMS.B2CWebApp
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
          SDMS_B2CWebApp_url: ${{ vars.SDMS_B2CWebApp_url }}
          SDMS_AuthenticationWebApp_url: ${{ vars.SDMS_AuthenticationWebApp_url }}
          SDMS_AuthenticationWebApp_clientid: ${{ vars.SDMS_AuthenticationWebApp_clientid }}
          SDMS_AuthenticationWebApp_redirectUri: ${{ vars.SDMS_AuthenticationWebApp_redirectUri }}
          SDMS_AuthenticationWebApp_scope: ${{ vars.SDMS_AuthenticationWebApp_scope }}
          CI: 'true'
        run: |
          echo "=== Syncing Vercel Environment Variables ==="
          
          # Function to sync environment variable
          sync_env_var() {
            local var_name=$1
            local var_value=$2
            local environment=$3
            
            # Trim whitespace
            var_value=$(printf '%s' "$var_value" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' | tr -d '\n\r\t')
            
            # Skip if empty
            if [ -z "${var_value}" ] || [ ${#var_value} -eq 0 ]; then
              echo "‚ö†Ô∏è  Skipping $var_name for $environment (empty value)"
              return 0
            fi
            
            echo "Syncing $var_name for $environment..."
            
            # Remove existing variable
            printf "y\n" | vercel env rm "$var_name" "$environment" --token="$VERCEL_TOKEN" 2>&1 | grep -v -E "(error|Error|NOTE|telemetry)" || true
            sleep 1
            
            # Add the environment variable
            printf '%s' "$var_value" | vercel env add "$var_name" "$environment" --token="$VERCEL_TOKEN" 2>&1 | grep -v -E "(NOTE|telemetry)" || true
            sleep 1
            
            # Verify
            if vercel env ls "$environment" --token="$VERCEL_TOKEN" 2>/dev/null | grep -q "^$var_name"; then
              echo "  ‚úÖ $var_name synced successfully"
            else
              echo "  ‚ö†Ô∏è  $var_name sync may have failed"
            fi
          }
          
          # Sync for production
          echo "=== Production Environment ==="
          sync_env_var "SDMS_B2CWebApp_url" "$SDMS_B2CWebApp_url" "production"
          sync_env_var "SDMS_AuthenticationWebApp_url" "$SDMS_AuthenticationWebApp_url" "production"
          sync_env_var "SDMS_AuthenticationWebApp_clientid" "$SDMS_AuthenticationWebApp_clientid" "production"
          sync_env_var "SDMS_AuthenticationWebApp_redirectUri" "$SDMS_AuthenticationWebApp_redirectUri" "production"
          sync_env_var "SDMS_AuthenticationWebApp_scope" "$SDMS_AuthenticationWebApp_scope" "production"
          
          # Sync for preview
          echo ""
          echo "=== Preview Environment ==="
          sync_env_var "SDMS_B2CWebApp_url" "$SDMS_B2CWebApp_url" "preview"
          sync_env_var "SDMS_AuthenticationWebApp_url" "$SDMS_AuthenticationWebApp_url" "preview"
          sync_env_var "SDMS_AuthenticationWebApp_clientid" "$SDMS_AuthenticationWebApp_clientid" "preview"
          sync_env_var "SDMS_AuthenticationWebApp_redirectUri" "$SDMS_AuthenticationWebApp_redirectUri" "preview"
          sync_env_var "SDMS_AuthenticationWebApp_scope" "$SDMS_AuthenticationWebApp_scope" "preview"
          
          echo ""
          echo "‚úÖ Environment variable sync complete"

      - name: Install dependencies
        working-directory: SDMSApps/SDMS.B2CWebApp/ClientApp
        run: npm ci

      - name: Build Angular app
        working-directory: SDMSApps/SDMS.B2CWebApp/ClientApp
        run: npm run build

      - name: Verify Vercel project settings before deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
        run: |
          echo "=== Final Verification of Vercel Project Settings ==="
          ROOT_DIR="SDMSApps/SDMS.B2CWebApp"
          
          # Get current project settings
          SETTINGS=$(curl -s -X GET \
            "https://api.vercel.com/v9/projects/$VERCEL_PROJECT_ID?teamId=$VERCEL_ORG_ID" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" 2>&1)
          
          if echo "$SETTINGS" | grep -q "rootDirectory"; then
            CURRENT_ROOT=$(echo "$SETTINGS" | grep -o '"rootDirectory":"[^"]*"' | cut -d'"' -f4 || echo "not found")
            echo "Current root directory in Vercel: $CURRENT_ROOT"
            echo "Expected root directory: $ROOT_DIR"
            
            if [ "$CURRENT_ROOT" != "$ROOT_DIR" ]; then
              echo ""
              echo "‚ö†Ô∏è  WARNING: Root directory mismatch!"
              echo "   Vercel has: $CURRENT_ROOT"
              echo "   Expected: $ROOT_DIR"
              echo ""
              echo "   Deployment may fail. Please update manually:"
              echo "   1. Go to https://vercel.com/freelancingsols-projects/sdms/settings"
              echo "   2. Settings ‚Üí General ‚Üí Root Directory"
              echo "   3. Set to: $ROOT_DIR"
              echo "   4. Save"
              echo ""
              echo "   Continuing with deployment attempt..."
            else
              echo "‚úÖ Root directory is correctly set"
            fi
          else
            echo "‚ö†Ô∏è  Could not verify root directory from API"
          fi

      - name: Deploy to Vercel
        working-directory: SDMSApps/SDMS.B2CWebApp
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ vars.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}
          CI: 'true'
        run: |
          echo "=== Deploying to Vercel ==="
          echo "Current directory: $(pwd)"
          echo ""
          
          # Verify vercel.json exists
          echo "Verifying vercel.json exists..."
          if [ ! -f "vercel.json" ]; then
            echo "‚ùå ERROR: vercel.json not found in $(pwd)"
            echo "Files in current directory:"
            ls -la
            exit 1
          fi
          echo "‚úÖ vercel.json found at: $(pwd)/vercel.json"
          echo ""
          
          # Verify .vercel/project.json exists
          if [ ! -f ".vercel/project.json" ]; then
            echo "‚ö†Ô∏è  .vercel/project.json not found, creating it..."
            mkdir -p .vercel
            echo "{\"orgId\":\"$VERCEL_ORG_ID\",\"projectId\":\"$VERCEL_PROJECT_ID\"}" > .vercel/project.json
            echo "‚úÖ Created .vercel/project.json"
          else
            echo "‚úÖ .vercel/project.json exists"
          fi
          echo ""
          
          # Deploy using Vercel CLI
          # Note: The --scope flag ensures we use the correct team/org
          # The working-directory ensures we're in the right place
          echo "Deploying to Vercel production..."
          echo "Command: vercel --prod --force --token=*** --scope=$VERCEL_ORG_ID --yes"
          echo ""
          
          vercel --prod --force --token="$VERCEL_TOKEN" --scope="$VERCEL_ORG_ID" --yes
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "‚úÖ Deployment completed successfully!"
          else
            echo ""
            echo "‚ùå Deployment failed"
            echo ""
            echo "If you see a root directory path error, please:"
            echo "1. Go to https://vercel.com/freelancingsols-projects/sdms/settings"
            echo "2. Settings ‚Üí General ‚Üí Root Directory"
            echo "3. Set to: SDMSApps/SDMS.B2CWebApp"
            echo "4. Save and retry deployment"
            exit 1
          fi
