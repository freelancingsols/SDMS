name: Error Handler and Reporter

# This workflow runs when other workflows fail
# It captures errors and creates detailed reports

on:
  workflow_run:
    workflows: 
      - "CI - B2C WebApp"
      - "CI - Authentication WebApp"
      - "Deploy B2C WebApp to Vercel"
      - "Deploy Authentication WebApp to Railway"
    types:
      - completed

jobs:
  analyze-and-report:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: actions/setup-cli@v1

      - name: Download workflow logs
        id: download-logs
        run: |
          gh run view ${{ github.event.workflow_run.id }} --log > workflow-logs.txt || echo "Could not download logs"
          echo "logs_file=workflow-logs.txt" >> $GITHUB_OUTPUT

      - name: Extract error details
        id: extract-errors
        run: |
          LOG_FILE="${{ steps.download-logs.outputs.logs_file }}"
          
          # Extract common error patterns
          if [ -f "$LOG_FILE" ]; then
            # NPM errors
            NPM_ERROR=$(grep -i "npm ERR\|npm error\|notarget\|ENOENT" "$LOG_FILE" | head -10 || echo "")
            
            # Build errors
            BUILD_ERROR=$(grep -i "error\|failed\|cannot find\|not found" "$LOG_FILE" | head -10 || echo "")
            
            # TypeScript/Angular errors
            TS_ERROR=$(grep -i "typescript\|angular\|compiler error" "$LOG_FILE" | head -10 || echo "")
            
            # Create error summary
            ERROR_SUMMARY=""
            if [ ! -z "$NPM_ERROR" ]; then
              ERROR_SUMMARY="${ERROR_SUMMARY}## NPM Errors\n\`\`\`\n${NPM_ERROR}\n\`\`\`\n\n"
            fi
            if [ ! -z "$BUILD_ERROR" ]; then
              ERROR_SUMMARY="${ERROR_SUMMARY}## Build Errors\n\`\`\`\n${BUILD_ERROR}\n\`\`\`\n\n"
            fi
            if [ ! -z "$TS_ERROR" ]; then
              ERROR_SUMMARY="${ERROR_SUMMARY}## TypeScript/Angular Errors\n\`\`\`\n${TS_ERROR}\n\`\`\`\n\n"
            fi
            
            echo "error_summary<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "error_summary=Could not extract errors from logs" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          ERROR_SUMMARY="${{ steps.extract-errors.outputs.error_summary }}"
          
          ISSUE_BODY=$(cat <<EOF
          ## Workflow Failure Report
          
          **Workflow:** ${WORKFLOW_NAME}
          **Run ID:** ${RUN_ID}
          **Branch:** ${BRANCH}
          **Commit:** ${COMMIT_SHA}
          **Run URL:** ${RUN_URL}
          
          ---
          
          ${ERROR_SUMMARY}
          
          ---
          
          ### Suggested Actions
          
          1. Review the error logs above
          2. Check if this is a known issue
          3. Apply fixes and re-run the workflow
          4. Close this issue when resolved
          
          ### Common Fixes
          
          - **NPM errors:** Try \`rm -f package-lock.json && npm install --legacy-peer-deps\`
          - **Build errors:** Check TypeScript/Angular versions match
          - **Missing dependencies:** Verify \`package.json\` has all required packages
          
          ---
          
          *This issue was auto-generated by the Error Handler workflow*
          EOF
          )
          
          # Check if issue already exists for this run
          EXISTING_ISSUE=$(gh issue list --label "ci-failure" --state open --limit 1 --json number --jq '.[0].number' || echo "")
          
          if [ -z "$EXISTING_ISSUE" ]; then
            gh issue create \
              --title "CI Failed: ${WORKFLOW_NAME} (Run ${RUN_ID})" \
              --body "$ISSUE_BODY" \
              --label "ci-failure,auto-generated" \
              --assignee "${{ github.event.workflow_run.actor.login }}"
          else
            echo "Issue #${EXISTING_ISSUE} already exists for this failure"
          fi

      - name: Generate Error Report
        run: |
          echo "## Workflow Failure Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.event.workflow_run.id }}" >> $GITHUB_STEP_SUMMARY
          echo "**View Logs:** [${{ github.event.workflow_run.html_url }}](${{ github.event.workflow_run.html_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.extract-errors.outputs.error_summary }}" >> $GITHUB_STEP_SUMMARY

      - name: Suggest Quick Fixes
        run: |
          LOG_FILE="${{ steps.download-logs.outputs.logs_file }}"
          
          if [ -f "$LOG_FILE" ]; then
            # Check for specific error patterns and suggest fixes
            if grep -qi "package-lock.json\|npm ERR" "$LOG_FILE"; then
              echo "### ðŸ”§ Suggested Fix" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This looks like an NPM dependency issue. Try:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "rm -f package-lock.json" >> $GITHUB_STEP_SUMMARY
              echo "rm -rf node_modules" >> $GITHUB_STEP_SUMMARY
              echo "npm install --legacy-peer-deps" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            
            if grep -qi "angular-devkit\|@angular" "$LOG_FILE"; then
              echo "### ðŸ”§ Suggested Fix" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "This looks like an Angular version mismatch. Check:" >> $GITHUB_STEP_SUMMARY
              echo "- All \`@angular/*\` packages are on the same version (^18.0.0)" >> $GITHUB_STEP_SUMMARY
              echo "- \`@angular-devkit/build-angular\` matches Angular version" >> $GITHUB_STEP_SUMMARY
              echo "- Remove old \`package-lock.json\` and reinstall" >> $GITHUB_STEP_SUMMARY
            fi
          fi

