name: Setup GitHub Secrets and Variables

on:
  workflow_dispatch:

jobs:
  setup-secrets-variables:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GH_TOKEN: ${{ secrets.SECRET_GENERATION_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify GitHub CLI
        run: |
          # GitHub CLI is pre-installed on GitHub Actions runners
          if command -v gh &> /dev/null; then
            echo "✅ GitHub CLI is installed"
            gh --version
          else
            echo "❌ Error: GitHub CLI is not installed on this runner"
            echo "Please use a GitHub Actions runner that has GitHub CLI pre-installed"
            exit 1
          fi

      - name: Verify GitHub CLI Authentication
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "❌ Error: SECRET_GENERATION_TOKEN secret is not set"
            echo "Please add SECRET_GENERATION_TOKEN to repository secrets:"
            echo "Repository → Settings → Secrets and variables → Actions → New repository secret"
            exit 1
          fi
          
          # GitHub CLI automatically uses GH_TOKEN environment variable
          echo "✅ Authenticating with GitHub CLI using GH_TOKEN"
          gh auth status

      - name: Read and set secrets from file
        id: set-secrets
        run: |
          SECRETS_FILE="SDMSApps/GITHUB_SECRETS.txt"
          
          if [ ! -f "$SECRETS_FILE" ]; then
            echo "❌ Error: $SECRETS_FILE not found"
            exit 1
          fi
          
          echo "Reading secrets from $SECRETS_FILE..."
          echo ""
          
          SECRETS_SUCCESS=0
          SECRETS_ERROR=0
          
          # Parse the file and set secrets
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines
            if [ -z "$line" ] || [ "$line" = "" ]; then
              continue
            fi
            
            # Skip lines that don't contain '='
            if [[ ! "$line" == *"="* ]]; then
              continue
            fi
            
            # Extract key and value
            KEY=$(echo "$line" | cut -d'=' -f1 | xargs)
            VALUE=$(echo "$line" | cut -d'=' -f2- | xargs)
            
            # Skip if key is empty
            if [ -z "$KEY" ]; then
              continue
            fi
            
            # Set secret using GitHub CLI
            echo -n "Setting secret $KEY... "
            OUTPUT=$(echo "$VALUE" | gh secret set "$KEY" --repo "${{ github.repository }}" 2>&1)
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "✅"
              SECRETS_SUCCESS=$((SECRETS_SUCCESS + 1))
            else
              echo "❌"
              echo "   Error: $OUTPUT"
              SECRETS_ERROR=$((SECRETS_ERROR + 1))
            fi
            
          done < "$SECRETS_FILE"
          
          echo ""
          echo "## Secrets Summary"
          echo "✅ Success: $SECRETS_SUCCESS"
          echo "❌ Errors: $SECRETS_ERROR"
          
          echo "secrets_success=$SECRETS_SUCCESS" >> $GITHUB_OUTPUT
          echo "secrets_error=$SECRETS_ERROR" >> $GITHUB_OUTPUT
          
          if [ $SECRETS_ERROR -gt 0 ]; then
            echo "⚠️  Some secrets failed to set"
          fi

      - name: Read and set variables from file
        id: set-variables
        run: |
          VARIABLES_FILE="SDMSApps/GITHUB_VARIABLES.txt"
          
          if [ ! -f "$VARIABLES_FILE" ]; then
            echo "❌ Error: $VARIABLES_FILE not found"
            exit 1
          fi
          
          echo "Reading variables from $VARIABLES_FILE..."
          echo ""
          
          VARIABLES_SUCCESS=0
          VARIABLES_ERROR=0
          
          # Parse the file and set variables
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines
            if [ -z "$line" ] || [ "$line" = "" ]; then
              continue
            fi
            
            # Skip lines that don't contain '='
            if [[ ! "$line" == *"="* ]]; then
              continue
            fi
            
            # Extract key and value
            KEY=$(echo "$line" | cut -d'=' -f1 | xargs)
            VALUE=$(echo "$line" | cut -d'=' -f2- | xargs)
            
            # Skip if key is empty
            if [ -z "$KEY" ]; then
              continue
            fi
            
            # Set variable using GitHub CLI
            echo -n "Setting variable $KEY... "
            OUTPUT=$(echo "$VALUE" | gh variable set "$KEY" --repo "${{ github.repository }}" 2>&1)
            EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "✅"
              VARIABLES_SUCCESS=$((VARIABLES_SUCCESS + 1))
            else
              echo "❌"
              echo "   Error: $OUTPUT"
              VARIABLES_ERROR=$((VARIABLES_ERROR + 1))
            fi
            
          done < "$VARIABLES_FILE"
          
          echo ""
          echo "## Variables Summary"
          echo "✅ Success: $VARIABLES_SUCCESS"
          echo "❌ Errors: $VARIABLES_ERROR"
          
          echo "variables_success=$VARIABLES_SUCCESS" >> $GITHUB_OUTPUT
          echo "variables_error=$VARIABLES_ERROR" >> $GITHUB_OUTPUT
          
          if [ $VARIABLES_ERROR -gt 0 ]; then
            echo "⚠️  Some variables failed to set"
          fi
          
          # Exit with error if any failures occurred
          TOTAL_ERRORS=$((${{ steps.set-secrets.outputs.secrets_error }} + VARIABLES_ERROR))
          if [ $TOTAL_ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Secrets and Variables Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Success: ${{ steps.set-secrets.outputs.secrets_success }}" >> $GITHUB_STEP_SUMMARY
          echo "- ❌ Errors: ${{ steps.set-secrets.outputs.secrets_error }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Variables" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Success: ${{ steps.set-variables.outputs.variables_success }}" >> $GITHUB_STEP_SUMMARY
          echo "- ❌ Errors: ${{ steps.set-variables.outputs.variables_error }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** All secrets and variables from the files have been set. Make sure to update placeholder values with actual values as needed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security:** Never commit actual secret values to the repository. Keep the files with placeholder values in the repository." >> $GITHUB_STEP_SUMMARY

