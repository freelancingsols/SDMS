name: Setup GitHub Secrets

on:
  workflow_dispatch:
    inputs:
      github_token:
        description: 'GitHub Personal Access Token (with repo and admin:repo_hook permissions)'
        required: true
        type: string

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (apt update && apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && apt update \
          && apt install gh -y

      - name: Authenticate with GitHub CLI
        run: |
          echo "${{ inputs.github_token }}" | gh auth login --with-token
          gh auth status

      - name: Read and set secrets from file
        run: |
          SECRETS_FILE="SDMSApps/GITHUB_SECRETS_FLAT_LIST.txt"
          
          if [ ! -f "$SECRETS_FILE" ]; then
            echo "❌ Error: $SECRETS_FILE not found"
            exit 1
          fi
          
          echo "Reading secrets from $SECRETS_FILE..."
          echo ""
          
          SUCCESS_COUNT=0
          SKIP_COUNT=0
          ERROR_COUNT=0
          
          # Parse the file and set secrets
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines
            if [ -z "$line" ] || [ "$line" = "" ]; then
              continue
            fi
            
            # Skip lines that don't contain '='
            if [[ ! "$line" == *"="* ]]; then
              continue
            fi
            
            # Extract key and value
            KEY=$(echo "$line" | cut -d'=' -f1 | xargs)
            VALUE=$(echo "$line" | cut -d'=' -f2- | xargs)
            
            # Skip if key is empty
            if [ -z "$KEY" ]; then
              continue
            fi
            
            # Skip placeholder values
            if [[ "$VALUE" == *"your-"* ]] || [[ "$VALUE" == *"placeholder"* ]] || [ -z "$VALUE" ]; then
              echo "⚠️  Skipping $KEY (placeholder or empty value)"
              SKIP_COUNT=$((SKIP_COUNT + 1))
              continue
            fi
            
            # Set secret using GitHub CLI
            echo -n "Setting $KEY... "
            if echo "$VALUE" | gh secret set "$KEY" --repo "${{ github.repository }}" 2>&1; then
              echo "✅"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "❌"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            
          done < "$SECRETS_FILE"
          
          echo ""
          echo "## Summary"
          echo "✅ Success: $SUCCESS_COUNT"
          echo "⚠️  Skipped: $SKIP_COUNT"
          echo "❌ Errors: $ERROR_COUNT"
          
          if [ $ERROR_COUNT -gt 0 ]; then
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Secrets Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Secrets have been set from GITHUB_SECRETS_FLAT_LIST.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Placeholder values were skipped. Make sure to update the file with actual values before running this workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security:** After running this workflow, revert the secrets file to placeholder values and never commit actual secrets." >> $GITHUB_STEP_SUMMARY

