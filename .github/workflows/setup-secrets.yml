name: Setup GitHub Secrets

on:
  workflow_dispatch:

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      secrets: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify GitHub CLI
        run: |
          # GitHub CLI is pre-installed on GitHub Actions runners
          if command -v gh &> /dev/null; then
            echo "✅ GitHub CLI is installed"
            gh --version
          else
            echo "❌ Error: GitHub CLI is not installed on this runner"
            echo "Please use a GitHub Actions runner that has GitHub CLI pre-installed"
            exit 1
          fi

      - name: Authenticate with GitHub CLI
        run: |
          echo "${{ secrets.SECRET_GENERATION_TOKEN }}" | gh auth login --with-token
          gh auth status
        env:
          GH_TOKEN: ${{ secrets.SECRET_GENERATION_TOKEN }}

      - name: Read and set secrets from file
        run: |
          SECRETS_FILE="SDMSApps/GITHUB_SECRETS_FLAT_LIST.txt"
          
          if [ ! -f "$SECRETS_FILE" ]; then
            echo "❌ Error: $SECRETS_FILE not found"
            exit 1
          fi
          
          echo "Reading secrets from $SECRETS_FILE..."
          echo ""
          
          SUCCESS_COUNT=0
          ERROR_COUNT=0
          
          # Parse the file and set secrets
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines
            if [ -z "$line" ] || [ "$line" = "" ]; then
              continue
            fi
            
            # Skip lines that don't contain '='
            if [[ ! "$line" == *"="* ]]; then
              continue
            fi
            
            # Extract key and value
            KEY=$(echo "$line" | cut -d'=' -f1 | xargs)
            VALUE=$(echo "$line" | cut -d'=' -f2- | xargs)
            
            # Skip if key is empty
            if [ -z "$KEY" ]; then
              continue
            fi
            
            # Set secret using GitHub CLI (set all values, even if empty or placeholder)
            echo -n "Setting $KEY... "
            if echo "$VALUE" | gh secret set "$KEY" --repo "${{ github.repository }}" 2>&1; then
              echo "✅"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "❌"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            
          done < "$SECRETS_FILE"
          
          echo ""
          echo "## Summary"
          echo "✅ Success: $SUCCESS_COUNT"
          echo "❌ Errors: $ERROR_COUNT"
          
          if [ $ERROR_COUNT -gt 0 ]; then
            exit 1
          fi

      - name: Summary
        run: |
          echo "## Secrets Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Secrets have been set from GITHUB_SECRETS_FLAT_LIST.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** All secrets from the file have been set. Make sure to update placeholder values with actual values as needed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security:** Never commit actual secret values to the repository. Keep the file with placeholder values in the repository." >> $GITHUB_STEP_SUMMARY

